<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymFlow Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-roboto">
    <div id="root"></div>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const initialExercisesList = [
            "Squat", "Deadlift", "Pulldown", "Row", "Benchpress", "Shoulderpress", 
            "Bicep Curls", "Tricep Extensions", "Ham Curl", "Glute Thrust", 
            "Shrugs", "Chest Fly", "Delt Fly"
        ];

        // Time utilities
        const formatTime = (timeInSeconds) => {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = timeInSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        const parseTime = (timeString) => {
            try {
                if (!timeString || timeString === '0') return 0;
                const [minutes, seconds] = timeString.split(':').map(Number);
                if (isNaN(minutes) || isNaN(seconds) || seconds >= 60 || minutes < 0 || seconds < 0) {
                    console.error('Invalid time format:', timeString);
                    return 0;
                }
                return minutes * 60 + seconds;
            } catch (error) {
                console.error('Error parsing time:', error);
                return 0;
            }
        };

        // Timer Hook
        const useTimer = (page, isResting, timer, setTimer, setIsResting) => {
            useEffect(() => {
                let interval;
                if (page === 'workout' && isResting && timer > 0) {
                    interval = setInterval(() => {
                        setTimer(prevTime => {
                            if (prevTime <= 3 && prevTime > 0) {
                                console.log('Playing countdown sound at', prevTime);
                                vibrateDevice();
                            }
                            if (prevTime === 0) {
                                console.log('Playing timer complete sound');
                                vibrateDevice();
                            }
                            if (prevTime > 0) {
                                return prevTime - 1;
                            } else {
                                try {
                                    vibrateDevice();
                                } catch (error) {
                                    console.error('Sound play failed:', error);
                                }
                                setIsResting(false);
                                return 0;
                            }
                        });
                    }, 1000);
                } else if (page === 'liveWorkout' && isResting) {
                    interval = setInterval(() => {
                        setTimer(prevTime => {
                            const newTime = prevTime + 1;
                            if (newTime % 60 === 0) {
                                try {
                                    vibrateDevice();
                                } catch (error) {
                                    console.error('Sound play failed:', error);
                                }
                            }
                            return newTime;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [page, isResting, timer]);
        };

        // MultiSetAdder Component
        const MultiSetAdder = ({ exerciseIndex, addSet }) => {
            const [numberOfSets, setNumberOfSets] = useState(1);

            const handleAddSets = () => {
                if (numberOfSets > 0) {
                    addSet(exerciseIndex, numberOfSets);
                }
            };

            const handleNumberChange = (e) => {
                const value = e.target.value;
                // Allow empty string (for deletion) or positive numbers
                if (value === '' || parseInt(value) > 0) {
                    setNumberOfSets(value === '' ? '' : parseInt(value));
                }
            };

            return (
                <div className="mb-4 flex items-center space-x-2">
                    <input 
                        type="number" 
                        value={numberOfSets}
                        onChange={handleNumberChange}
                        className="border p-2 rounded w-24 text-lg"
                        min="1"
                        placeholder="1"
                    />
                    <button 
                        onClick={handleAddSets}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-lg"
                        disabled={!numberOfSets || numberOfSets < 1}
                    >
                        Add Sets
                    </button>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [workout, setWorkout] = useState([]);
            const [currentExercise, setCurrentExercise] = useState('');
            const [currentSet, setCurrentSet] = useState({ reps: 0, weight: 0, exertion: 0 });
            const [history, setHistory] = useState([]);
            const [liveWorkout, setLiveWorkout] = useState([]);
            const [timer, setTimer] = useState(0);
            const [isResting, setIsResting] = useState(false);
            const [savedWorkouts, setSavedWorkouts] = useState([]);
            const [workoutName, setWorkoutName] = useState('');
            const [exercisesList, setExercisesList] = useState(initialExercisesList);
            const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
            const [currentSetIndex, setCurrentSetIndex] = useState(0);
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [progressData, setProgressData] = useState({});
            const [workoutNotes, setWorkoutNotes] = useState('');
            const [statistics, setStatistics] = useState({
                totalWorkouts: 0,
                totalVolume: 0,
                personalBests: {},
                frequentExercises: {}
            });
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [isLoading, setIsLoading] = useState(true);

            // Use the custom timer hook
            useTimer(page, isResting, timer, setTimer, setIsResting);

            useEffect(() => {
                try {
                    const storedHistory = localStorage.getItem('history');
                    const storedWorkouts = localStorage.getItem('savedWorkouts');
                    const storedUser = localStorage.getItem('user');
                    
                    if (storedHistory) setHistory(JSON.parse(storedHistory));
                    if (storedWorkouts) setSavedWorkouts(JSON.parse(storedWorkouts));
                    if (storedUser) setUser(JSON.parse(storedUser));
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                    // Clear corrupted data
                    localStorage.clear();
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                if (user) {
                    localStorage.setItem(`history_${user.username}`, JSON.stringify(history));
                }
            }, [history, user]);

            useEffect(() => {
                if (user) {
                    localStorage.setItem(`savedWorkouts_${user.username}`, JSON.stringify(savedWorkouts));
                }
            }, [savedWorkouts, user]);

            const handleLogin = () => {
                // In a real app, you would validate credentials against a backend
                const newUser = { username, password };
                setUser(newUser);
                localStorage.setItem('user', JSON.stringify(newUser));
                
                // Load user-specific data
                const storedSavedWorkouts = localStorage.getItem(`savedWorkouts_${username}`);
                if (storedSavedWorkouts) {
                    setSavedWorkouts(JSON.parse(storedSavedWorkouts));
                }
                
                const storedHistory = localStorage.getItem(`history_${username}`);
                if (storedHistory) {
                    setHistory(JSON.parse(storedHistory));
                }
                
                setUsername('');
                setPassword('');
            };

            const handleSignup = () => {
                // In a real app, you would send this data to a backend
                const newUser = { username, password };
                setUser(newUser);
                localStorage.setItem('user', JSON.stringify(newUser));
                setUsername('');
                setPassword('');
            };

            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('user');
            };

            const resetCreateWorkoutPage = () => {
                setWorkout([]);
                setCurrentExercise('');
                setWorkoutName('');
            };

            const addExercise = () => {
                if (currentExercise) {
                    setWorkout([...workout, { name: currentExercise, sets: [] }]);
                    setCurrentExercise('');
                }
            };

            const addCustomExercise = () => {
                if (currentExercise && !exercisesList.includes(currentExercise)) {
                    setExercisesList([...exercisesList, currentExercise]);
                    addExercise();
                }
            };

            const addSet = (exerciseIndex, numberOfSets = 1) => {
                const newWorkout = workout.map((exercise, index) => {
                    if (index === exerciseIndex) {
                        const newSets = [...exercise.sets];
                        for (let i = 0; i < numberOfSets; i++) {
                            newSets.push({ reps: 0, weight: 0, rest: '0:00' });
                        }
                        return { ...exercise, sets: newSets };
                    }
                    return exercise;
                });
                setWorkout(newWorkout);
            };

            const removeSet = (exerciseIndex, setIndex) => {
                const newWorkout = workout.map((exercise, index) => {
                    if (index === exerciseIndex) {
                        const newSets = exercise.sets.filter((_, i) => i !== setIndex);
                        return { ...exercise, sets: newSets };
                    }
                    return exercise;
                });
                setWorkout(newWorkout);
            };

            const handleSetChange = (exerciseIndex, setIndex, field, value) => {
                const newWorkout = workout.map((exercise, index) => {
                    if (index === exerciseIndex) {
                        const newSets = exercise.sets.map((set, i) => {
                            if (i === setIndex) {
                                if (field === 'rest') {
                                    // Ensure rest time is within valid range (0-59:59)
                                    const [min, sec] = value.split(':').map(Number);
                                    const validMin = Math.min(Math.max(0, min || 0), 59);
                                    const validSec = Math.min(Math.max(0, sec || 0), 59);
                                    value = `${validMin}:${validSec.toString().padStart(2, '0')}`;
                                }
                                return { ...set, [field]: value };
                            }
                            return set;
                        });
                        return { ...exercise, sets: newSets };
                    }
                    return exercise;
                });
                setWorkout(newWorkout);
            };

            const removeExercise = (indexToRemove) => {
                setWorkout(workout.filter((_, index) => index !== indexToRemove));
            };

            const startWorkout = () => {
                if (workout.length === 0) {
                    alert('Please add at least one exercise before starting the workout');
                    return;
                }
                
                if (workout.some(exercise => exercise.sets.length === 0)) {
                    alert('Please add at least one set to each exercise');
                    return;
                }
                
                setCurrentExerciseIndex(0);
                setCurrentSetIndex(0);
                setPage('workout');
            };

            const completeSet = () => {
                // Get the rest time from the current set
                const currentExerciseSet = workout[currentExerciseIndex].sets[currentSetIndex];
                const restTimeInSeconds = parseTime(currentExerciseSet.rest);
                setTimer(restTimeInSeconds);
                setIsResting(true);
            };

            const nextSet = () => {
                setIsResting(false);
                setTimer(0);
                if (currentSetIndex < workout[currentExerciseIndex].sets.length - 1) {
                    setCurrentSetIndex(currentSetIndex + 1);
                } else {
                    if (currentExerciseIndex < workout.length - 1) {
                        setCurrentExerciseIndex(currentExerciseIndex + 1);
                        setCurrentSetIndex(0);
                    } else {
                        finishWorkout();
                    }
                }
            };

            const finishWorkout = () => {
                if (!window.confirm('Are you sure you want to finish this workout?')) {
                    return;
                }
                
                const newHistory = [...history, { 
                    workout, 
                    date: new Date(),
                    notes: workoutNotes,
                    volume: calculateTotalVolume({ workout })
                }];
                setHistory(newHistory);
                localStorage.setItem('history', JSON.stringify(newHistory));
                setWorkoutNotes('');
                setPage('home');
                resetCreateWorkoutPage();
                setCurrentExerciseIndex(0);
                setCurrentSetIndex(0);
                updateStatistics();
            };

            const startLiveWorkout = () => {
                setPage('liveWorkout');
            };

            const completeLiveSet = () => {
                if (!currentExercise || !currentSet.reps || !currentSet.weight) {
                    alert('Please fill in exercise, reps, and weight');
                    return;
                }

                console.log('Completing set:', { currentExercise, currentSet });
                
                setIsResting(true);
                setTimer(0);
                const existingExerciseIndex = liveWorkout.findIndex(set => set.exercise === currentExercise);
                
                if (existingExerciseIndex !== -1) {
                    const updatedLiveWorkout = [...liveWorkout];
                    updatedLiveWorkout[existingExerciseIndex] = {
                        ...updatedLiveWorkout[existingExerciseIndex],
                        reps: updatedLiveWorkout[existingExerciseIndex].reps + ',' + currentSet.reps,
                        weight: updatedLiveWorkout[existingExerciseIndex].weight + ',' + currentSet.weight,
                        exertion: updatedLiveWorkout[existingExerciseIndex].exertion + ',' + currentSet.exertion,
                        totalSets: updatedLiveWorkout[existingExerciseIndex].totalSets + 1
                    };
                    console.log('Updating existing exercise:', updatedLiveWorkout[existingExerciseIndex]);
                    setLiveWorkout(updatedLiveWorkout);
                } else {
                    const newExercise = { 
                        ...currentSet, 
                        exercise: currentExercise, 
                        totalSets: 1,
                        reps: currentSet.reps.toString(),
                        weight: currentSet.weight.toString(),
                        exertion: currentSet.exertion.toString()
                    };
                    console.log('Adding new exercise:', newExercise);
                    setLiveWorkout([...liveWorkout, newExercise]);
                }
            };

            const restDone = () => {
                setIsResting(false);
                const updatedLiveWorkout = [...liveWorkout];
                const lastExerciseIndex = updatedLiveWorkout.length - 1;
                updatedLiveWorkout[lastExerciseIndex] = {
                    ...updatedLiveWorkout[lastExerciseIndex],
                    rest: updatedLiveWorkout[lastExerciseIndex].rest 
                        ? updatedLiveWorkout[lastExerciseIndex].rest + ',' + formatTime(timer)
                        : formatTime(timer)
                };
                setLiveWorkout(updatedLiveWorkout);
                setTimer(0);
            };

            const finishLiveWorkout = () => {
                if (liveWorkout.length === 0) {
                    alert('No exercises recorded');
                    return;
                }

                if (!window.confirm('Are you sure you want to finish this workout?')) {
                    return;
                }

                // Save workout to history
                const workoutEntry = {
                    liveWorkout: [...liveWorkout],
                    date: new Date(),
                    notes: workoutNotes,
                    volume: calculateTotalVolume({ liveWorkout })
                };

                const newHistory = [...history, workoutEntry];
                setHistory(newHistory);
                localStorage.setItem('history', JSON.stringify(newHistory));

                // Reset all states
                setLiveWorkout([]);
                setWorkoutNotes('');
                setCurrentSet({ reps: 0, weight: 0, exertion: 0 });
                setCurrentExercise('');
                setTimer(0);
                setIsResting(false);
                setPage('home');
            };

            const saveWorkout = () => {
                if (user) {
                    const newSavedWorkouts = [...savedWorkouts, { name: workoutName, workout }];
                    setSavedWorkouts(newSavedWorkouts);
                    localStorage.setItem(`savedWorkouts_${user.username}`, JSON.stringify(newSavedWorkouts));
                    setWorkoutName('');
                    resetCreateWorkoutPage();
                } else {
                    alert('Please log in to save workouts');
                }
            };

            const loadWorkout = (savedWorkout) => {
                if (user) {
                    setWorkout(savedWorkout.workout);
                    startWorkout();
                } else {
                    alert('Please log in to load workouts');
                }
            };

            const editSavedWorkout = (index) => {
                const workoutToEdit = savedWorkouts[index];
                setWorkout(workoutToEdit.workout);
                setWorkoutName(workoutToEdit.name);
                setPage('editWorkout');
            };

            const updateWorkout = () => {
                if (user) {
                    const updatedSavedWorkouts = savedWorkouts.map(savedWorkout => 
                        savedWorkout.name === workoutName ? { name: workoutName, workout } : savedWorkout
                    );
                    setSavedWorkouts(updatedSavedWorkouts);
                    localStorage.setItem(`savedWorkouts_${user.username}`, JSON.stringify(updatedSavedWorkouts));
                    setPage('savedWorkouts');
                } else {
                    alert('Please log in to update workouts');
                }
            };

            const deleteSavedWorkout = (index) => {
                if (user) {
                    const newSavedWorkouts = savedWorkouts.filter((_, i) => i !== index);
                    setSavedWorkouts(newSavedWorkouts);
                    localStorage.setItem(`savedWorkouts_${user.username}`, JSON.stringify(newSavedWorkouts));
                }
            };

            const generateProgressData = () => {
                const data = {};
                history.forEach(entry => {
                    if (!entry.date) return; // Skip if no date
                    
                    const date = new Date(entry.date).toLocaleDateString();
                    
                    if (entry.workout) {
                        entry.workout.forEach(exercise => {
                            if (!data[exercise.name]) {
                                data[exercise.name] = {
                                    dates: [],
                                    weights: []
                                };
                            }
                            const maxWeight = Math.max(...exercise.sets.map(set => 
                                parseInt(set.weight) || 0
                            ));
                            if (maxWeight > 0) {
                                data[exercise.name].dates.push(date);
                                data[exercise.name].weights.push(maxWeight);
                            }
                        });
                    } else if (entry.liveWorkout) {
                        entry.liveWorkout.forEach(set => {
                            if (!data[set.exercise]) {
                                data[set.exercise] = {
                                    dates: [],
                                    weights: []
                                };
                            }
                            const weights = set.weight.split(',').map(w => parseInt(w) || 0);
                            const maxWeight = Math.max(...weights);
                            if (maxWeight > 0) {
                                data[set.exercise].dates.push(date);
                                data[set.exercise].weights.push(maxWeight);
                            }
                        });
                    }
                });
                setProgressData(data);
            };

            useEffect(() => {
                generateProgressData();
            }, [history]);

            useEffect(() => {
                if (page === 'progress') {
                    // Destroy existing charts first
                    Object.keys(progressData).forEach(exercise => {
                        const canvas = document.getElementById(`chart-${exercise}`);
                        const existingChart = Chart.getChart(canvas);
                        if (existingChart) {
                            existingChart.destroy();
                        }
                    });

                    // Create new charts
                    Object.entries(progressData).forEach(([exercise, data]) => {
                        const ctx = document.getElementById(`chart-${exercise}`);
                        if (!ctx) return;

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.dates,
                                datasets: [{
                                    label: 'Max Weight (lbs)',
                                    data: data.weights,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Weight (lbs)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        }
                                    }
                                }
                            }
                        });
                    });
                }
            }, [page, progressData]);

            const calculateTotalVolume = (entry) => {
                let volume = 0;
                if (entry.workout) {
                    entry.workout.forEach(exercise => {
                        exercise.sets.forEach(set => {
                            volume += (parseInt(set.reps) || 0) * (parseInt(set.weight) || 0);
                        });
                    });
                } else if (entry.liveWorkout) {
                    entry.liveWorkout.forEach(exercise => {
                        const reps = exercise.reps.split(',').map(r => parseInt(r) || 0);
                        const weights = exercise.weight.split(',').map(w => parseInt(w) || 0);
                        reps.forEach((rep, i) => {
                            volume += rep * (weights[i] || 0);
                        });
                    });
                }
                return volume;
            };

            const calculatePersonalBests = () => {
                const pbs = {};
                history.forEach(entry => {
                    if (entry.workout) {
                        entry.workout.forEach(exercise => {
                            const maxWeight = Math.max(...exercise.sets.map(set => parseInt(set.weight) || 0));
                            if (!pbs[exercise.name] || maxWeight > pbs[exercise.name]) {
                                pbs[exercise.name] = maxWeight;
                            }
                        });
                    } else if (entry.liveWorkout) {
                        entry.liveWorkout.forEach(exercise => {
                            const weights = exercise.weight.split(',').map(w => parseInt(w) || 0);
                            const maxWeight = Math.max(...weights);
                            if (!pbs[exercise.exercise] || maxWeight > pbs[exercise.exercise]) {
                                pbs[exercise.exercise] = maxWeight;
                            }
                        });
                    }
                });
                return pbs;
            };

            const getMostFrequentExercises = () => {
                const frequency = {};
                history.forEach(entry => {
                    if (entry.workout) {
                        entry.workout.forEach(exercise => {
                            frequency[exercise.name] = (frequency[exercise.name] || 0) + 1;
                        });
                    } else if (entry.liveWorkout) {
                        entry.liveWorkout.forEach(exercise => {
                            frequency[exercise.exercise] = (frequency[exercise.exercise] || 0) + 1;
                        });
                    }
                });
                return frequency;
            };

            const updateStatistics = () => {
                const stats = {
                    totalWorkouts: history.length,
                    totalVolume: history.reduce((total, entry) => total + (entry.volume || calculateTotalVolume(entry)), 0),
                    personalBests: calculatePersonalBests(),
                    frequentExercises: getMostFrequentExercises()
                };
                setStatistics(stats);
            };

            useEffect(() => {
                updateStatistics();
            }, [history]);

            const renderWorkoutForm = (onSubmit, submitButtonText) => (
                <div className="text-lg">
                    <h2 className="text-3xl font-bold mb-6">Create Your Workout</h2>
                    <div className="mb-4">
                        <label className="block mb-2">Select Exercise</label>
                        <select value={currentExercise} onChange={(e) => setCurrentExercise(e.target.value)} className="border p-2 rounded w-full">
                            <option value="">-- Select Exercise --</option>
                            {exercisesList.map((exercise, index) => (
                                <option key={index} value={exercise}>{exercise}</option>
                            ))}
                        </select>
                        <input type="text" placeholder="Or enter custom exercise" className="border p-2 rounded w-full mt-2" value={currentExercise} onChange={(e) => setCurrentExercise(e.target.value)} />
                        <div className="flex space-x-2 mt-2">
                            <button onClick={addExercise} className="bg-blue-500 text-white px-4 py-2 rounded">Add Exercise</button>
                            <button onClick={addCustomExercise} className="bg-green-500 text-white px-4 py-2 rounded">Add Custom Exercise</button>
                        </div>
                    </div>
                    {workout.map((exercise, exerciseIndex) => (
                        <div key={exerciseIndex} className="mb-6 p-4 bg-white rounded shadow">
                            <h3 className="text-2xl font-bold mb-4">{exercise.name}</h3>
                            <MultiSetAdder 
                                exerciseIndex={exerciseIndex} 
                                addSet={(exerciseIndex, numberOfSets) => addSet(exerciseIndex, numberOfSets)} 
                            />
                            {exercise.sets.map((set, setIndex) => (
                                <div key={setIndex} className="mb-6 p-4 bg-gray-50 rounded">
                                    <h4 className="text-xl font-bold mb-3">Set {setIndex + 1}</h4>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-lg mb-2">Reps</label>
                                            <input 
                                                type="number"
                                                min="0"
                                                step="1"
                                                className="border p-3 rounded w-full text-xl"
                                                value={set.reps}
                                                onChange={(e) => handleSetChange(exerciseIndex, setIndex, 'reps', e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-lg mb-2">Weight</label>
                                            <input 
                                                type="number"
                                                min="0"
                                                step="2.5"
                                                className="border p-3 rounded w-full text-xl"
                                                value={set.weight}
                                                onChange={(e) => handleSetChange(exerciseIndex, setIndex, 'weight', e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-lg mb-2">Rest Time</label>
                                            <div className="flex items-center">
                                                <input 
                                                    type="number"
                                                    min="0"
                                                    max="59"
                                                    className="border p-3 rounded-l w-1/2 text-xl"
                                                    value={set.rest.split(':')[0] || '0'}
                                                    onChange={(e) => {
                                                        const min = Math.min(Math.max(0, parseInt(e.target.value) || 0), 59);
                                                        const sec = set.rest.split(':')[1] || '00';
                                                        handleSetChange(exerciseIndex, setIndex, 'rest', `${min}:${sec}`);
                                                    }}
                                                />
                                                <span className="text-xl px-2">:</span>
                                                <input 
                                                    type="number"
                                                    min="0"
                                                    max="59"
                                                    className="border p-3 rounded-r w-1/2 text-xl"
                                                    value={set.rest.split(':')[1] || '00'}
                                                    onChange={(e) => {
                                                        const min = set.rest.split(':')[0] || '0';
                                                        const sec = Math.min(Math.max(0, parseInt(e.target.value) || 0), 59).toString().padStart(2, '0');
                                                        handleSetChange(exerciseIndex, setIndex, 'rest', `${min}:${sec}`);
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex space-x-2 mt-3">
                                        {setIndex === 0 && (
                                            <button 
                                                onClick={() => {
                                                    const newWorkout = [...workout];
                                                    newWorkout[exerciseIndex].sets = newWorkout[exerciseIndex].sets.map(s => ({...set}));
                                                    setWorkout(newWorkout);
                                                }}
                                                className="bg-green-500 text-white px-4 py-2 rounded text-lg"
                                            >
                                                Apply to All Sets
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => removeSet(exerciseIndex, setIndex)}
                                            className="bg-red-500 text-white px-4 py-2 rounded text-lg"
                                        >
                                            Remove Set
                                        </button>
                                    </div>
                                </div>
                            ))}
                            <button 
                                onClick={() => removeExercise(exerciseIndex)}
                                className="bg-red-500 text-white px-6 py-3 rounded text-lg"
                            >
                                Remove Exercise
                            </button>
                        </div>
                    ))}
                    <div className="mb-4">
                        <input type="text" placeholder="Workout Name" className="border p-2 rounded w-full mt-2" value={workoutName} onChange={(e) => setWorkoutName(e.target.value)} />
                        <button onClick={onSubmit} className="bg-yellow-500 text-white px-4 py-2 rounded mt-2">{submitButtonText}</button>
                    </div>
                    <div className="mb-4">
                        <button onClick={startWorkout} className="bg-green-500 text-white px-4 py-2 rounded">Start Workout</button>
                    </div>
                    <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded">Back to Menu</button>
                </div>
            );

            const vibrateDevice = () => {
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            };

            return (
                <div className="container mx-auto p-4">
                    {isLoading ? (
                        <div className="text-center p-4">
                            <h2 className="text-xl">Loading...</h2>
                        </div>
                    ) : (
                        <>
                            {page === 'home' && (
                                <div className="text-center p-4">
                                    <h1 className="text-4xl font-bold mb-8">GymFlow Pro</h1>
                                    <div className="flex flex-col space-y-4 max-w-xs mx-auto px-4">
                                        <button 
                                            onClick={() => { setPage('createWorkout'); resetCreateWorkoutPage(); }} 
                                            className="bg-blue-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            Create Your Workout
                                        </button>
                                        <button 
                                            onClick={() => setPage('liveWorkout')} 
                                            className="bg-green-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            Live Workout
                                        </button>
                                        <button 
                                            onClick={() => setPage('savedWorkouts')} 
                                            className="bg-yellow-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            Saved Workouts
                                        </button>
                                        <button 
                                            onClick={() => setPage('history')} 
                                            className="bg-gray-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            View History
                                        </button>
                                        <button 
                                            onClick={() => setPage('progress')} 
                                            className="bg-purple-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            View Progress
                                        </button>
                                        <button 
                                            onClick={() => setPage('statistics')} 
                                            className="bg-indigo-500 text-white px-4 py-3 rounded-lg text-lg"
                                        >
                                            View Statistics
                                        </button>
                                    </div>
                                </div>
                            )}

                            {page === 'createWorkout' && renderWorkoutForm(saveWorkout, "Save Workout")}

                            {page === 'editWorkout' && renderWorkoutForm(updateWorkout, "Update Workout")}

                            {page === 'workout' && (
                                <div className="text-center">
                                    <h2 className="text-3xl font-bold mb-6">Workout</h2>
                                    {workout.length > 0 && (
                                        <div className="mb-8">
                                            <h3 className="text-5xl font-bold mb-6">{workout[currentExerciseIndex].name}</h3>
                                            <h4 className="text-3xl font-bold mb-4">Set {currentSetIndex + 1} of {workout[currentExerciseIndex].sets.length}</h4>
                                            <p className="text-4xl mb-4">Reps: {workout[currentExerciseIndex].sets[currentSetIndex].reps}</p>
                                            <p className="text-4xl mb-4">Weight: {workout[currentExerciseIndex].sets[currentSetIndex].weight}</p>
                                            <p className="text-4xl mb-4">Rest: {workout[currentExerciseIndex].sets[currentSetIndex].rest}</p>
                                            {isResting ? (
                                                <div className="mb-6">
                                                    <h3 className="text-6xl font-bold mb-4">Rest Time: {formatTime(timer)}</h3>
                                                    {(currentSetIndex + 1 < workout[currentExerciseIndex].sets.length) ? (
                                                        <div className="mt-4 p-4 bg-gray-100 rounded">
                                                            <h4 className="text-xl font-bold">Next Set:</h4>
                                                            <p>Reps: {workout[currentExerciseIndex].sets[currentSetIndex + 1].reps}</p>
                                                            <p>Weight: {workout[currentExerciseIndex].sets[currentSetIndex + 1].weight}</p>
                                                        </div>
                                                    ) : (currentExerciseIndex + 1 < workout.length) ? (
                                                        <div className="mt-4 p-4 bg-gray-100 rounded">
                                                            <h4 className="text-xl font-bold">Next Exercise:</h4>
                                                            <p>{workout[currentExerciseIndex + 1].name}</p>
                                                            <p>Reps: {workout[currentExerciseIndex + 1].sets[0].reps}</p>
                                                            <p>Weight: {workout[currentExerciseIndex + 1].sets[0].weight}</p>
                                                        </div>
                                                    ) : null}
                                                    <button onClick={nextSet} className="bg-green-500 text-white px-6 py-3 rounded text-xl mt-4">Next Set</button>
                                                </div>
                                            ) : (
                                                <button 
                                                    onClick={completeSet} 
                                                    className="bg-blue-500 text-white px-8 py-4 rounded text-2xl"
                                                >
                                                    Complete Set
                                                </button>
                                            )}
                                        </div>
                                    )}
                                    <button onClick={finishWorkout} className="bg-red-500 text-white px-6 py-3 rounded text-xl">Finish Workout</button>
                                    <div className="mt-4">
                                        <textarea
                                            value={workoutNotes}
                                            onChange={(e) => setWorkoutNotes(e.target.value)}
                                            placeholder="Add workout notes..."
                                            className="w-full p-2 border rounded"
                                            rows="4"
                                        />
                                    </div>
                                </div>
                            )}

                            {page === 'liveWorkout' && (
                                <div>
                                    <h2 className="text-2xl font-bold mb-4">Live Workout</h2>
                                    <div className="mb-4">
                                        <label className="block mb-2">Select Exercise</label>
                                        <select value={currentExercise} onChange={(e) => setCurrentExercise(e.target.value)} className="border p-2 rounded w-full">
                                            <option value="">-- Select Exercise --</option>
                                            {exercisesList.map((exercise, index) => (
                                                <option key={index} value={exercise}>{exercise}</option>
                                            ))}
                                        </select>
                                        <input type="text" placeholder="Or enter custom exercise" className="border p-2 rounded w-full mt-2" value={currentExercise} onChange={(e) => setCurrentExercise(e.target.value)} />
                                    </div>
                                    <div className="mb-4">
                                        <h3 className="font-bold">{currentExercise}</h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="block mb-1">Reps</label>
                                                <input type="number" placeholder="Reps" value={currentSet.reps} onChange={(e) => setCurrentSet({ ...currentSet, reps: e.target.value })} className="border p-2 rounded w-full" />
                                            </div>
                                            <div>
                                                <label className="block mb-1">Weight</label>
                                                <input type="number" placeholder="Weight" value={currentSet.weight} onChange={(e) => setCurrentSet({ ...currentSet, weight: e.target.value })} className="border p-2 rounded w-full" />
                                            </div>
                                            <div>
                                                <label className="block mb-1">Exertion (1-10)</label>
                                                <input type="number" min="1" max="10" placeholder="Exertion" value={currentSet.exertion} onChange={(e) => setCurrentSet({ ...currentSet, exertion: Math.min(10, Math.max(1, parseInt(e.target.value) || 0)) })} className="border p-2 rounded w-full" />
                                            </div>
                                        </div>
                                    </div>
                                    {isResting ? (
                                        <div className="text-center mb-4">
                                            <h3 className="text-4xl font-bold">Rest Timer: {formatTime(timer)}</h3>
                                            <button onClick={restDone} className="bg-green-500 text-white px-4 py-2 rounded mt-2">Rest Done</button>
                                        </div>
                                    ) : (
                                        <button onClick={completeLiveSet} className="bg-blue-500 text-white px-4 py-2 rounded">Complete Set</button>
                                    )}
                            <div className="mt-4">
                                <textarea
                                    value={workoutNotes}
                                    onChange={(e) => setWorkoutNotes(e.target.value)}
                                    placeholder="Add workout notes..."
                                    className="w-full p-2 border rounded"
                                    rows="4"
                                />
                            </div>
                            <div className="mt-4">
                                <h3 className="text-xl font-bold mb-2">Current Workout Log</h3>
                                {liveWorkout.map((exercise, index) => (
                                    <div key={index} className="mb-4 p-4 bg-white rounded shadow">
                                        <h4 className="font-bold">{exercise.exercise}</h4>
                                        <p>Sets: {exercise.totalSets}</p>
                                        <p>Reps: {exercise.reps}</p>
                                        <p>Weight: {exercise.weight}</p>
                                        <p>Exertion: {exercise.exertion}</p>
                                        {exercise.rest && <p>Rest Times: {exercise.rest}</p>}
                                    </div>
                                ))}
                            </div>
                            <div className="mt-4 flex space-x-2">
                                <button onClick={finishLiveWorkout} className="bg-green-500 text-white px-4 py-2 rounded">Finish Workout</button>
                                <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded">Back to Menu</button>
                            </div>
                        </div>
                    )}

                    {page === 'history' && (
                        <div>
                            <h2 className="text-2xl font-bold mb-4">Workout History</h2>
                            {history.map((entry, index) => (
                                <div key={index} className="mb-4 border p-4 rounded">
                                    <h3 className="font-bold">Workout on {new Date(entry.date).toLocaleString()}</h3>
                                    {entry.workout ? (
                                        entry.workout.map((exercise, exerciseIndex) => (
                                            <div key={exerciseIndex} className="mb-4">
                                                <h3 className="font-bold">{exercise.name} - Total Sets: {exercise.sets.length}</h3>
                                                <p>Reps: {exercise.sets.map(set => set.reps).join(', ')}</p>
                                                <p>Weight: {exercise.sets.map(set => set.weight).join(', ')}</p>
                                                <p>Rest: {exercise.sets.map(set => set.rest).join(', ')}</p>
                                            </div>
                                        ))
                                    ) : entry.liveWorkout && (
                                        entry.liveWorkout.map((exercise, exerciseIndex) => (
                                            <div key={exerciseIndex} className="mb-4">
                                                <h3 className="font-bold">{exercise.exercise} - Total Sets: {exercise.totalSets}</h3>
                                                <p>Reps: {exercise.reps}</p>
                                                <p>Weight: {exercise.weight}</p>
                                                <p>Rest: {exercise.rest || 'N/A'}</p>
                                            </div>
                                        ))
                                    )}
                                    {entry.notes && <p className="mt-2 italic">Notes: {entry.notes}</p>}
                                    {entry.volume && <p className="mt-2">Total Volume: {entry.volume.toLocaleString()} lbs</p>}
                                    <button onClick={() => setHistory(history.filter((_, i) => i !== index))} className="bg-red-500 text-white px-4 py-2 rounded mt-2">Delete</button>
                                </div>
                            ))}
                            <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded">Back to Menu</button>
                        </div>
                    )}

                    {page === 'savedWorkouts' && (
                        <div>
                            <h2 className="text-2xl font-bold mb-4">Saved Workouts</h2>
                            {savedWorkouts.map((savedWorkout, index) => (
                                <div key={index} className="mb-4 border p-4 rounded">
                                    <h3 className="font-bold">{savedWorkout.name}</h3>
                                    <div className="flex space-x-2 mt-2">
                                        <button onClick={() => loadWorkout(savedWorkout)} className="bg-blue-500 text-white px-4 py-2 rounded">Load Workout</button>
                                        <button onClick={() => editSavedWorkout(index)} className="bg-yellow-500 text-white px-4 py-2 rounded">Edit</button>
                                        <button onClick={() => deleteSavedWorkout(index)} className="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
                                    </div>
                                </div>
                            ))}
                            <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded">Back to Menu</button>
                        </div>
                    )}

                    {page === 'progress' && (
                        <div>
                            <h2 className="text-2xl font-bold mb-4">Workout Progress</h2>
                            <div className="grid grid-cols-2 gap-4">
                                {Object.keys(progressData).map(exercise => (
                                    <div key={exercise} className="mb-8 p-4 bg-white rounded shadow">
                                        <h3 className="text-xl font-bold mb-2">{exercise}</h3>
                                        <div style={{height: "300px", position: "relative"}}>
                                            <canvas id={`chart-${exercise}`}></canvas>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded mt-4">
                                Back to Menu
                            </button>
                        </div>
                    )}

                    {page === 'statistics' && (
                        <div className="p-4">
                            <h2 className="text-2xl font-bold mb-4">Workout Statistics</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-white p-4 rounded shadow">
                                    <h3 className="text-xl font-bold mb-2">Overview</h3>
                                    <p>Total Workouts: {statistics.totalWorkouts}</p>
                                    <p>Total Volume: {statistics.totalVolume.toLocaleString()} lbs</p>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <h3 className="text-xl font-bold mb-2">Personal Bests</h3>
                                    {Object.entries(statistics.personalBests).map(([exercise, weight]) => (
                                        <p key={exercise}>{exercise}: {weight} lbs</p>
                                    ))}
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <h3 className="text-xl font-bold mb-2">Most Frequent Exercises</h3>
                                    {Object.entries(statistics.frequentExercises)
                                        .sort(([,a], [,b]) => b - a)
                                        .map(([exercise, count]) => (
                                            <p key={exercise}>{exercise}: {count} times</p>
                                        ))}
                                </div>
                            </div>
                            <button onClick={() => setPage('home')} className="bg-gray-500 text-white px-4 py-2 rounded mt-4">
                                Back to Menu
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="text-center p-4">
                            <h1 className="text-2xl font-bold text-red-500">Something went wrong</h1>
                            <button 
                                onClick={() => window.location.reload()} 
                                className="bg-blue-500 text-white px-4 py-2 rounded mt-4"
                            >
                                Reload App
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
    </script>
</body>
</html> 
